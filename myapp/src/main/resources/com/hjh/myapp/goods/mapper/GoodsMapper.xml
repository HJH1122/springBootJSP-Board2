<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/dtd/mybatis-3-mapper.dtd"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hjh.myapp.goods.mapper.GoodsMapper">

	<select id="list" resultType="com.hjh.myapp.goods.vo.GoodsVO">
		SELECT
		    g.goods_no,
		    g.goods_name,
		    p.price,
		    p.discount,
		    p.discount_rate,
		    g.hit,
		    g.image_name
		FROM goods g
		LEFT JOIN price p
		    ON g.goods_no = p.goods_no
		    AND p.sale_startDate <![CDATA[ <= ]]> CURDATE()
		    AND CURDATE() <![CDATA[ <= ]]> p.sale_endDate
		WHERE
			1 = 1
			<include refid="search" />
		ORDER BY g.goods_no DESC
		LIMIT #{perPageNum} OFFSET #{limit}
	</select>
	
	<select id="getTotalRow" parameterType="com.hjh.myapp.util.page.PageObject" resultType="int">
	    SELECT COUNT(*)
	    FROM goods
	    WHERE 1 = 1
	    	<include refid="search" />
	    
	</select>
	
	<sql id="search">
	
	</sql>
	
	<update id="increase">
		update goods
		set hit = hit + 1
		where no = #{no}
	</update>
	
	<insert id="view">
	    select 
	    	no,
	    	title,
	    	content,
	    	writer,
	    	write_date AS writeDate,
	    	hit
	    	
	    from goods
	    where no = #{no}
	</insert>
	
	<insert id="write">
	    INSERT INTO category (cate_code1, cate_code2, cate_name)
	    SELECT
	        #{cate_code1},
	        IFNULL(MAX(cate_code2), 0) + 1,
	        #{cate_name}
	    FROM (
	        SELECT cate_code2
	        FROM category
	        WHERE cate_code1 = #{cate_code1}
	    ) t
	</insert>
	
	<update id="update">
		UPDATE goods
		SET 
			title = #{title},
			content = #{content},
			writer = #{writer}
		WHERE no = #{no} and pw = #{pw}
		
	</update>
	
	<delete id="delete">
		DELETE from goods
		WHERE 
			no = #{no}
		AND
			pw = #{pw}

	</delete>
	
	<select id="getCategory" parameterType="com.hjh.myapp.goods.vo.CategoryVO">
	    SELECT 
	    	cate_code1, cate_code2, cate_name
	    FROM category
	    WHERE
	    	<if test="cate_code1 = 0">
	    		cate_code2 = 0
	    	</if>
	    	<if test="cate_code1 != 0">
	    	    cate_code1 = #{cate_code1} and cate_code2 != 0
	    	</if>
	    
	    	
	    
	</select>
	
	
	
</mapper>